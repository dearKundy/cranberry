InnoDB存储引擎是索引组织表，因此聚集索引页的叶子节点中存放着完整的记录，辅助索引页中记录存放着指向叶子节点的指针。

一般一个B+树结点存放的数据量就是一个磁盘页的大小。

## B+树索引
B+树是为 `磁盘` 或其他直接存取辅助设备而设计的一种平衡查找树。在B+树中，所有的记录结点都按键值的大小顺序存放在同一层的叶子节点。
个叶子节点指针进行连接。先来看一棵B+数，其高度为2，每页可存放4条记录，扇出为5，如下图所示
![image.png](https://i.loli.net/2020/06/08/4vnof8aOJlzSbhN.png)
可以看出，**所有记录都在叶子节点**，并且是顺序存放的，如果用户从最左边的叶节点开始顺序遍历，可以得到所有键值的顺序排序。

通常来说，B+树索引用于基本磁盘的数据库系统，即数据最后持久化存放在磁盘上。每个叶子节点一般包含较多的记录，因此具有较高的扇出。
这意味着在数据库中B+树的索引高度一般较小，在3~4层，而树的高度也决定了磁盘I/O搜索的次数，从而影响数据库的整体性能。

在MySQL 3.23版本的InnoDB存储引擎中，每个页的大小是16KB，假设平均每行记录的大小为100个字节，则每个页能存放的记录数量为160。
那么B+树高度高度为2的索引共能存放25600行记录，高度为3的索引功能存放4096000行记录，高度为4的索引共能存放655360000行记录。
因此若在高度为4的索引中，根据键值从6亿多的记录中查询一行记录，那么共需要4次I/O操作。当前一块普通机械磁盘IOPS可达100，
那么4次I/O查询大约需要0.04秒。可见B+树索引的查询还是非常高效的。

需要注意的是B+树索引只能找到记录所在的页，但是并不能定位到记录在页中的具体位置（偏移量），这需要通过page directory的二分查找得到
具体的记录。然而，由于通过B+树索引得知记录所在的页后，InnoDB存储引擎将页加载到缓冲池中，二分查找在内存中完成，速度很快，
因此一般忽略这个查询开销。

## 聚簇索引
> InnoDB存储引擎将B+树索引分为聚集索引和辅助索引两种。

聚集索引是通过将表的主键作为键值来构造B+树。因为InnoDB存储引擎是索引组织表，这意味着每张表都有一个主键，若没有显式地创建，
则InnoDB存储引擎会自动创建一个6字节的主键。聚集索引不仅包含索引的键值，还包含记录其他所有列的信息。

聚集索引中的记录是根据键值顺序存放的。然而要特别注意的是这个顺序是指逻辑顺序。

聚集索引的**非叶子节点**存放的是<键值，地址>对。地址为指向下一层的指针，InnoDB存储引擎通过页在表空间中的偏移量来表示。
主键索引的**叶子节点**存放的是整行的数据。

InnoDB聚集索引的叶子节点存储行记录，因此， InnoDB必须要有，`且只有一个聚集索引`：
1. 如果表定义了PK，则PK就是聚集索引；
2. 如果表没有定义PK，则第一个not NULL unique列是聚集索引；
3. 否则，InnoDB会创建一个隐藏的row-id作为聚集索引；

## 辅助索引
辅助索引，又称为二级索引或非聚集索引。其和聚集索引一样，同样是之前所介绍的B+树结构。然而辅助索引的叶子节点并不保存记录中的所有列，
其叶子节点保存的是<键值，（记录）地址>。这好似之前聚集索引中非叶子节点保存的信息。然而不同的是，辅助索引叶子节点中保存的是记录的地址，
而在聚集索引非叶子节点中保存的是下一层节点的页地址。

## 回表
普通索引无法直接定位行记录，那普通索引的查询过程是怎么样的呢？
通常情况下，需要扫码两遍索引树。
![image.png](https://i.loli.net/2020/06/09/f6cRrb1t98wQWHX.png)

如粉红色路径，需要扫码两遍索引树：
1. 先通过普通索引定位到主键值id=5；
2. 在通过聚集索引定位到行记录；

这就是所谓的回表查询，先定位主键值，再定位行记录，它的性能较扫一遍索引树更低。

## 什么是覆盖索引
直接从非聚簇索引就能获取到想要查询的字段，不需要回表。


参考文章：
- [https://zhuanlan.zhihu.com/p/62018452](https://zhuanlan.zhihu.com/p/62018452)
- [https://www.cnblogs.com/myseries/p/11265849.html](https://www.cnblogs.com/myseries/p/11265849.html)


